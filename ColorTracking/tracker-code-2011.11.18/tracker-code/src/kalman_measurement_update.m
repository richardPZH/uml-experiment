function [x_t_plus_1_given_t_plus_1, P_t_plus_1_given_t_plus_1] = ...
  kalman_measurement_update(y_t_plus_1, x_t_plus_1_given_t, ...
			    P_t_plus_1_given_t, kalparam)
% [x_t_plus_1_given_t_plus_1, P_t_plus_1_given_t_plus_1] = ...
%  kalman_measurement_update(y_t_plus_1, x_t_plus_1_given_t, ...
%			    P_t_plus_1_given_t, kalparam)
% This function implements the measurement update equation as required
% for the Kalman filter. New observations y_t_plus_1 are absorbed into
% the state estimate defined by x_t_plus_1_given_t and
% P_t_plus_1_given_t to yield a new state estimate defined by a new mean x and
% covariance P. 

% Incorporate evidence
x_t_plus_1_given_t_plus_1 = x_t_plus_1_given_t + ...
    P_t_plus_1_given_t * kalparam.B' * ...
    inv(kalparam.B * P_t_plus_1_given_t * kalparam.B' + kalparam.R) * ...
    (y_t_plus_1 - kalparam.B * x_t_plus_1_given_t);

P_t_plus_1_given_t_plus_1  = P_t_plus_1_given_t - ...
    P_t_plus_1_given_t * kalparam.B' * inv(kalparam.B * P_t_plus_1_given_t * kalparam.B' + kalparam.R) * ...
    kalparam.B * P_t_plus_1_given_t;
